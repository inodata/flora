{% extends 'InodataFloraBundle::base_edit.html.twig' %}
{% block stylesheets %}
	{{ parent() }}
	{% stylesheets '@InodataFloraBundle/Resources/public/css/select2.css' %}
		<link rel="stylesheet" href="{{ asset_url }}" />
	{% endstylesheets %}
	<style>
		div.list-products-content{ width:100%;}
		div.list-products-content .table-1 {float:left; width:80%;}
		div.list-products-content .table-2 { float:right; width: 20%;}
	</style>
{% endblock %}
{% block javascripts %}
	{{ parent() }}	
	{% javascripts '@InodataFloraBundle/Resources/public/js/select2.js' 
				   '@InodataFloraBundle/Resources/public/js/select2_locale_es.js'
	%}
		<script type="text/javascript" src="{{ asset_url }}" ></script>
	{% endjavascripts %}
	<script>
        $(document).ready(function() { 

            $(".inodata_customer").select2({ 
        		allowClear: true
        	});

            $(".inodata_payment_contact").select2({ 
                allowClear: true
            });

        	$(".inodata_product").select2({
                placeholder: "Selecciona un producto",
        		allowClear: true
            });

            //-- Select a product and insert to select-options and list  --//
            $(".inodata_product").change(function(){
                url = $('#add_product_url').val();
                id = $(this).val();
                url = url.replace("%20", id);
                
                $.get(url, function(data){

                    hideEmptyNotification();
                    
                    if($('#'+data.id).length==0){
                    	//Add new new row if product doesn't exist
                        $(".list-products tbody").append(data.listField);
                    }else{
                        //Update total if exist
                        var cant = parseInt($('#'+data.id+" input").val());
                    	$('#'+data.id+" input").val(cant+1);
                    }
                    
                    //Add select option with product selected
                    $(".products-to-buy").append(data.selectOption);

                    //Clear select
                    $(".inodata_product").select2('val', '');

                    //Update totals table
                    updatePriceTotals();
                    
                }, 'json');
            });
            //--------------------------------------------------------------//

            //-----Delete product from list and select options ----//
            $(".delete_link").live('click', function(){
                var id = $(this).closest("tr").attr('id');
                
				//Remove from list
                $(this).closest("tr").remove();
                //Remove from select
                $(".products-to-buy ."+id).remove();

                updatePriceTotals();
                showEmptyNotification();
            });
            //-----------------------------------------------------//
            
            //----------Load initial data for edit order ----------//
            var id = $(".order-id").val();
            $(".products-to-buy option").remove();
            
            if(id!=''){
            	var url = $("#add_products_url").val();
            	url = url.replace("%20", id);
                
                $.get(url, function(data){
                	$(".list-products tbody").append(data.listFields);
                	$(".products-to-buy").append(data.selectOptions);
                	hideEmptyNotification();
                	//Load price totals for the order editing
                	loadPriceTotals(data.totals);
                }, 'json');
            }
			//----------------------------------------//
            

            function showEmptyNotification(){
            	if($(".product").length==0){
                	$("#no_products").css('display', 'table-row'); 
                }
            }

            function hideEmptyNotification(){
            	if($("#no_products").length>0){
                    $("#no_products").css('display', 'none'); 
                }
            }

            //Update product list and select-option when total is change
            $('.product-total').live('keydown', function(event){
                if(event.which==13){
                    if($(this).val().match('^(0|[0-9][0-9]*)$')){
                    	var id = $(this).closest('tr').attr('id');
                        var cant = parseInt($(this).val());

                        var nOptions = $("."+id).length;
                        while(nOptions != cant){
                            if(nOptions<cant){
                            	var option = $("."+id).last().clone();
                            	$(".products-to-buy").append(option);
                            }else{
                            	$("."+id).last().remove();
                            }

                            nOptions = $("."+id).length;
                        }

                        //Realizar calculos monetarios
                    }else{
                        alert('Cantidad invalida');
                    }

                    updatePriceTotals();
                                       
                    return false;
                }
            });
			//------------------------------------------------------------//
			
			//-----Update prices when shipping or discount changes -----//
			$('.order-shipping, .order-discount').live('keypress', function(event){
				if(event.which==13){
					if($(this).val().match('[0-9]+(\.[0-9][0-9]?)?')){
						updatePriceTotals();
					}else{
						alert('Cantidad invalida');
						$(this).val('0');
					}

					return false;
				}
			});
			
			//---------------- Hide select-option fields -----------------//
			hideElement($('.products-to-buy'));
			hideElement($('.order-shipping:first'));
			hideElement($('.order-discount:first'));
			
			function hideElement(element){
				$(element).closest('.control-group').css('display', 'none');
			}
			//------------------------------------------------------------//

			function loadPriceTotals(price)
			{
				$(".order-subtotal").text(price.subtotal);
				$(".order-shipping").val(price.shipping);
				$(".order-discount").val(price.discount);
				$(".order-iva").text(price.iva);
				$(".order-total").text(price.total);
			}

			function updatePriceTotals()
			{
				var o_subtotal=0.0;
				$(".product").each(function(){
					var o_price = parseFloat($(this).children(':nth-child(4)').text());
					var o_cant = parseInt($(this).find(".product-total").val());

					o_subtotal+=(o_price*o_cant);
				});

				var o_shipping = parseFloat($('.order-shipping').eq(1).val());
				var o_discount = parseFloat($('.order-discount').eq(1).val());
				var o_iva = (o_subtotal+o_shipping-o_discount)*0.16;
				var o_total =  o_subtotal+o_shipping-o_discount+o_iva;

				var prices = {subtotal:o_subtotal, shipping:o_shipping, 
						  discount:o_discount, iva:o_iva, total:o_total};
				  
				loadPriceTotals(prices);
			}
        });
    </script>
{% endblock %}

{% block sonata_fieldsets %}
  <input type="hidden" id="add_product_url" value="{{ path('inodata_flora_order_product', {'id' : ' '}) }}" />
  <input type="hidden" id="add_products_url" value="{{ path('inodata_flora_order_products', {'id' : ' '}) }}" />
    <div class="tab-content">
        {% for name, form_group in admin.formgroups %}
            {% if name != 'Productos' %}
                <div class="tab-pane {% if loop.first %} active{% endif %}" id="{{ name }}">
                    <fieldset>
                        <div class="sonata-ba-collapsed-fields">
                            {% if form_group.description != false %}
                                <p>{{ form_group.description|raw }}</p>
                            {% endif %}

                            {% for field_name in form_group.fields %}
                                {% if admin.formfielddescriptions[field_name] is defined %}
                                    {{ form_row(form[field_name])}}
                                {% endif %}
                            {% endfor %}
                        </div>
                    </fieldset>
                </div>
            {% else %}
                <div class="tab-pane {% if loop.first %} active{% endif %}" id="{{ name }}">
                    <fieldset>
                        <div class="sonata-ba-collapsed-fields">
                            {% if form_group.description != false %}
                                <p>{{ form_group.description|raw }}</p>
                            {% endif %}

                            {% for field_name in form_group.fields %}
                                {% if admin.formfielddescriptions[field_name] is defined %}
                                    {{ form_row(form[field_name])}}
                                {% endif %}
                            {% endfor %}
                        </div>
                    </fieldset>
                    {% block products_table %}
                    	<div class="list-products-content">
                    		<div class="table-1">
                            <table class="table table-bordered table-striped list-products">
                                {% block table_header %}
                                    <thead>
                                        <tr class="sonata-ba-list-field-header">
                                            {% spaceless %}
                                                <th class="sonata-ba-list-field-header-text" >
                                                    Cantidad
                                                </th>
                                                <th class="sonata-ba-list-field-header-text" >
                                                    Clave
                                                </th>
                                                <th class="sonata-ba-list-field-header-text" >
                                                    Descripción
                                                </th>
                                                <th class="sonata-ba-list-field-header-text" >
                                                    Precio
                                                </th>
                                                <th class="sonata-ba-list-field-header-text" >
                                                    Acciones
                                                </th>
                                            {% endspaceless %}
                                        </tr>
                                    </thead>
                                {% endblock %}

                                {% block table_body %}
                                    <tbody>
                                        <tr id="no_products" >
                                            <td colspan="5" class="sonata-ba-list-field sonata-ba-list-field-text" >
                                                <p class="notice">
                                                    No hay productos seleccionados.
                                                </p>
                                            </td>                 
                                        </tr>
                                    </tbody>
                                {% endblock %}

                                {% block table_footer %}
                                                 
                                {% endblock %}
                            </table>
                            </div>
                            <div class="table-2">
                            <table class="table table-bordered pay-table">
                            	<thead>
                            		<tr><th colspan="2">Totales</th></tr>
                            	</thead>
                            	<tbody>
                            		<tr><td>Subtotal:</td><td>$ <span class="order-subtotal">0</span></td></tr>
                            		<tr>
                            			<td>Envío:</td>
                            			<td>$ <input type="number" class="order-shipping" value="65.00" style="width: 70%;"/></td>
                            		</tr>
                            		<tr>
                            			<td>Descuento:</td>
                            			<td>$ <input type="number" class="order-discount" value="50.00" style="width: 70%;"/></td>
                            		</tr>
                            		<tr style="border-bottom: 1px solid #000;">
                            			<td>IVA(16%):</td>
                            			<td>$ <span class="order-iva">0</span></td>
                            		</tr>
                            	</tbody>
                            	<tfoot>
                            		<tr>
                            			<th>Total:</th>
                            			<th>$ <span class="order-total">0</span></th>
                            		</tr>
                            	</tfoot>
                            </table>
                            </div>
                    	</div>
                    {% endblock %}
                </div>                
            {% endif %}
        {% endfor %}
    </div>
{% endblock %}
