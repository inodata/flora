{% extends 'InodataFloraBundle::base_edit.html.twig' %}
{% block stylesheets %}
	{{ parent() }}
	{% stylesheets '@InodataFloraBundle/Resources/public/css/select2.css' %}
		<link rel="stylesheet" href="{{ asset_url }}" />
	{% endstylesheets %}
{% endblock %}
{% block javascripts %}
	{{ parent() }}	
	{% javascripts '@InodataFloraBundle/Resources/public/js/select2.js' 
				   '@InodataFloraBundle/Resources/public/js/select2_locale_es.js'
	%}
		<script type="text/javascript" src="{{ asset_url }}" ></script>
	{% endjavascripts %}
	<script>
        $(document).ready(function() { 

            $(".inodata_customer").select2({ 
        		allowClear: true
        	});

            $(".inodata_payment_contact").select2({ 
                allowClear: true
            });

        	$(".inodata_product").select2({
                placeholder: "Selecciona un producto",
        		allowClear: true
            });

            //-- Select a product and insert to select-options and list  --//
            $(".inodata_product").change(function(){
                url = $('#add_product_url').val();
                id = $(this).val();
                url = url.replace("%20", id);
                
                $.get(url, function(data){

                    hideEmptyNotification();
                    
                    if($('#'+data.id).length==0){
                    	//Add new new row if product doesn't exist
                        $(".table tbody").append(data.listField);
                    }else{
                        //Update total if exist
                        var cant = parseInt($('#'+data.id+" input").val());
                    	$('#'+data.id+" input").val(cant+1);
                    }
                    
                    //Add select option with product selected
                    $(".products-to-buy").append(data.selectOption);

                    //Clear select
                    $(".inodata_product").select2('val', '');
                }, 'json');
            });
            //--------------------------------------------------------------//

            //-----Delete product from list and select options ----//
            $(".delete_link").live('click', function(){
                var id = $(this).closest("tr").attr('id');
                
				//Remove from list
                $(this).closest("tr").remove();
                //Remove from select
                $(".products-to-buy ."+id).remove();
                
                showEmptyNotification();
            });
            //-----------------------------------------------------//
            
            //----------Load initial data for edit order ----------//
            var id = $(".order-id").val();
            $(".products-to-buy option").remove();
            
            if(id!=''){
            	var url = $("#add_products_url").val();
            	url = url.replace("%20", id);
                
                $.get(url, function(data){
                	$(".table tbody").append(data.listFields);
                	$(".products-to-buy").append(data.selectOptions);
                	hideEmptyNotification();
                }, 'json');
            }
			//----------------------------------------//
            

            function showEmptyNotification(){
            	if($(".product").length==0){
                	$("#no_products").css('display', 'table-row'); 
                }
            }

            function hideEmptyNotification(){
            	if($("#no_products").length>0){
                    $("#no_products").css('display', 'none'); 
                }
            }

            //Update product list and select-option when total is change
            
            /*$('.product-total').live('keydown', function(event){
                if(event.which==13){
                    if($(this).val().match('^(1|[1-9][1-9]*)$')){
                    	var id = $(this).closest('tr').attr('id');
                        var cant = parseInt($(this).val());

                        var nOptions = $("."+id).length;
                        while(nOptions != cant){
                            if(nOptions<cant){
                            	var option = $("."+id).last();
                            	$(".products-to-buy").append(option);
                            }else{
                            	$("."+id).last().remove();
                            }

                            nOptions = $("."+id).length;
                        }
                    }else{
                        alert('Cantidad invalida');
                    }
                                       
                    return false;
                }
            });*/

        });
    </script>
{% endblock %}

{% block sonata_fieldsets %}
  <input type="hidden" id="add_product_url" value="{{ path('inodata_flora_order_product', {'id' : ' '}) }}" />
  <input type="hidden" id="add_products_url" value="{{ path('inodata_flora_order_products', {'id' : ' '}) }}" />
    <div class="tab-content">
        {% for name, form_group in admin.formgroups %}
            {% if name != 'Productos' %}
                <div class="tab-pane {% if loop.first %} active{% endif %}" id="{{ name }}">
                    <fieldset>
                        <div class="sonata-ba-collapsed-fields">
                            {% if form_group.description != false %}
                                <p>{{ form_group.description|raw }}</p>
                            {% endif %}

                            {% for field_name in form_group.fields %}
                                {% if admin.formfielddescriptions[field_name] is defined %}
                                    {{ form_row(form[field_name])}}
                                {% endif %}
                            {% endfor %}
                        </div>
                    </fieldset>
                </div>
            {% else %}
                <div class="tab-pane {% if loop.first %} active{% endif %}" id="{{ name }}">
                    <fieldset>
                        <div class="sonata-ba-collapsed-fields">
                            {% if form_group.description != false %}
                                <p>{{ form_group.description|raw }}</p>
                            {% endif %}

                            {% for field_name in form_group.fields %}
                                {% if admin.formfielddescriptions[field_name] is defined %}
                                    {{ form_row(form[field_name])}}
                                {% endif %}
                            {% endfor %}
                        </div>
                    </fieldset>
                    {% block products_table %}
                            <table class="table table-bordered table-striped">
                                {% block table_header %}
                                    <thead>
                                        <tr class="sonata-ba-list-field-header">
                                            {% spaceless %}
                                                <th class="sonata-ba-list-field-header-text" >
                                                    Cantidad
                                                </th>
                                                <th class="sonata-ba-list-field-header-text" >
                                                    Clave
                                                </th>
                                                <th class="sonata-ba-list-field-header-text" >
                                                    Descripci√≥n
                                                </th>
                                                <th class="sonata-ba-list-field-header-text" >
                                                    Precio
                                                </th>
                                                <th class="sonata-ba-list-field-header-text" >
                                                    Acciones
                                                </th>
                                            {% endspaceless %}
                                        </tr>
                                    </thead>
                                {% endblock %}

                                {% block table_body %}
                                    <tbody>
                                        <tr id="no_products" >
                                            <td colspan="5" class="sonata-ba-list-field sonata-ba-list-field-text" >
                                                <p class="notice">
                                                    No hay productos seleccionados.
                                                </p>
                                            </td>                 
                                        </tr>
                                    </tbody>
                                {% endblock %}

                                {% block table_footer %}
                                    <tfoot>
                                        <tr>
                                            <th colspan="5">
                                                 Totales   
                                            </th>
                                        </tr>  
                                    </tfoot>              
                                {% endblock %}
                            </table>
                    {% endblock %}
                </div>                
            {% endif %}
        {% endfor %}
    </div>
{% endblock %}
